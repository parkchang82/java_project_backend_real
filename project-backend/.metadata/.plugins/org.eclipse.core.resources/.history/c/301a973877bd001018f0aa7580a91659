package com.example.demo;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configurers.AbstractHttpConfigurer;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.web.cors.CorsConfiguration;
import org.springframework.web.cors.CorsConfigurationSource;
import org.springframework.web.cors.UrlBasedCorsConfigurationSource;

import java.util.Arrays;
import java.util.List;

@Configuration
@EnableWebSecurity
public class SecurityConfig {

    // 1. PasswordEncoder (ë¹„ë°€ë²ˆí˜¸ ì•”í˜¸í™”) ì„¤ì •
    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder(); // ê°€ì¥ ë„ë¦¬ ì‚¬ìš©ë˜ëŠ” ì•”í˜¸í™” ë°©ì‹
    }

    // 2. CORS ì„¤ì • (í”„ë¡ íŠ¸ì—”ë“œ í†µì‹  í—ˆìš©)
    @Bean
    public CorsConfigurationSource corsConfigurationSource() {
        CorsConfiguration configuration = new CorsConfiguration();
        
        // ğŸ’¡ í”„ë¡ íŠ¸ì—”ë“œê°€ ì‹¤í–‰ë˜ëŠ” ì£¼ì†Œ í—ˆìš©
        configuration.setAllowedOrigins(List.of("http://localhost:3000")); 
        
        // í—ˆìš©í•  HTTP ë©”ì„œë“œ (ë¡œê·¸ì¸ POST í¬í•¨)
        configuration.setAllowedMethods(Arrays.asList("GET", "POST", "PUT", "DELETE", "OPTIONS"));
        
        // ëª¨ë“  í—¤ë” í—ˆìš©
        configuration.setAllowedHeaders(List.of("*"));
        
        // ğŸ’¡ ì¸ì¦ ì •ë³´ (ì¿ í‚¤, JWT ë“±) êµí™˜ í—ˆìš©. Axiosì˜ withCredentials: trueì™€ ì—°ë™ë©ë‹ˆë‹¤.
        configuration.setAllowCredentials(true); 

        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        // ëª¨ë“  URL ê²½ë¡œì— CORS ì„¤ì • ì ìš©
        source.registerCorsConfiguration("/**", configuration); 
        return source;
    }

    // 3. Security Filter Chain (ì¸ì¦/ì¸ê°€ ê·œì¹™) ì„¤ì •
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        
        http
            // ê¸°ë³¸ HTTP ì¸ì¦ ë¹„í™œì„±í™” (APIì—ì„œëŠ” í† í°ì„ ì‚¬ìš©í•˜ë¯€ë¡œ)
            .httpBasic(AbstractHttpConfigurer::disable)
            
            // ğŸ’¡ CSRF ë³´í˜¸ ë¹„í™œì„±í™” (JWT/API í†µì‹ ì—ì„œëŠ” STATELESSí•˜ë¯€ë¡œ í•„ìš” ì—†ìŒ)
            .csrf(AbstractHttpConfigurer::disable)
            
            // ğŸ’¡ ìœ„ì—ì„œ ì •ì˜í•œ CORS ì„¤ì • ì ìš©
            .cors(cors -> cors.configurationSource(corsConfigurationSource()))
            
            // ğŸ’¡ ì„¸ì…˜ì„ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ (STATELESS) -> JWT í† í° ì‚¬ìš©ì˜ í•µì‹¬
            .sessionManagement(session -> session
                .sessionCreationPolicy(SessionCreationPolicy.STATELESS))
            
            // ì ‘ê·¼ ê¶Œí•œ ì„¤ì • (ìš”ì²­ ê²½ë¡œë³„ ì„¤ì •)
            .authorizeHttpRequests(authz -> authz
                // '/api/login' ê²½ë¡œëŠ” ëˆ„êµ¬ë‚˜ ì ‘ê·¼ ê°€ëŠ¥í•´ì•¼ í•¨ (ë¡œê·¸ì¸ ì „)
                .requestMatchers("/api/login", "/api/signup").permitAll()
                
                // ê·¸ ì™¸ ëª¨ë“  ìš”ì²­ì€ ì¸ì¦ë˜ì–´ì•¼ ì ‘ê·¼ ê°€ëŠ¥
                .anyRequest().authenticated() 
            );
            
            // TODO: ì‹¤ì œ JWT êµ¬í˜„ ì‹œ, ì—¬ê¸°ì— JWT ì¸ì¦ í•„í„°ë¥¼ ì¶”ê°€í•´ì•¼ í•©ë‹ˆë‹¤.

        return http.build();
    }
}