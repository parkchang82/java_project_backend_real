package com.example.study;

import com.example.study.domain.StudyRoom;
import com.example.study.domain.StudyRoomMember;
import com.example.study.repository.StudyRoomMemberRepository;
import com.example.study.repository.StudyRoomRepository;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/rooms")
public class StudyRoomController {

    private final StudyRoomRepository roomRepository;
    private final StudyRoomMemberRepository memberRepository;

    public StudyRoomController(StudyRoomRepository roomRepository,
                               StudyRoomMemberRepository memberRepository) {
        this.roomRepository = roomRepository;
        this.memberRepository = memberRepository;
    }

    // âœ… ë°© ìƒì„± ìš”ì²­ DTO
    public static record RoomCreateReq(String name, String description, String host) {}

    // âœ… ë°© ì°¸ì—¬ / ë‚˜ê°€ê¸° ìš”ì²­ DTO
    public static record JoinReq(String username) {}

    // ğŸŸ¢ ë°© ë§Œë“¤ê¸° : POST /rooms
    @PostMapping
    public StudyRoom createRoom(@RequestBody RoomCreateReq req) {
        StudyRoom room = new StudyRoom();
        room.setName(req.name());
        room.setDescription(req.description());
        room.setHost(req.host()); // ë°©ì¥ ì•„ì´ë””
        return roomRepository.save(room);
    }

    // ğŸ”µ ë°© ëª©ë¡ ë³´ê¸° : GET /rooms
    @GetMapping
    public List<StudyRoom> listRooms() {
        return roomRepository.findAll();
    }

    // ğŸ”µ ë°© í•˜ë‚˜ ìƒì„¸ : GET /rooms/{id}
    @GetMapping("/{id}")
    public StudyRoom getRoom(@PathVariable Long id) {
        return roomRepository.findById(id)
                .orElseThrow(() -> new RuntimeException("room not found: " + id));
    }

    // ğŸŸ¡ ë°© ì°¸ì—¬í•˜ê¸° : POST /rooms/{id}/join
    @PostMapping("/{id}/join")
    public String joinRoom(@PathVariable Long id,
                           @RequestBody JoinReq req) {

        StudyRoom room = roomRepository.findById(id)
                .orElseThrow(() -> new RuntimeException("room not found: " + id));

        // âš ï¸ ì—¬ê¸°ì„œë¶€í„°ëŠ” ì „ë¶€ ë©”ëª¨ë¦¬ì—ì„œ í•„í„°ë§ â†’ ì•ˆì „í•¨

        // ì´ë¯¸ ì°¸ì—¬í•œ ì‚¬ëŒì¸ì§€ ì²´í¬ (ì¤‘ë³µ ì°¸ì—¬ ë°©ì§€)
        boolean alreadyJoined = memberRepository.findAll().stream()
                .anyMatch(m ->
                        m.getRoom().getId().equals(id) &&
                        m.getUsername().equals(req.username())
                );

        if (alreadyJoined) {
            return "ì´ë¯¸ ì´ ë°©ì— ì°¸ì—¬í•œ ì‚¬ìš©ìì…ë‹ˆë‹¤.";
        }

        StudyRoomMember member = new StudyRoomMember();
        member.setRoom(room);
        member.setUsername(req.username());

        memberRepository.save(member);

        return "ì°¸ì—¬ ì™„ë£Œ";
    }

    // ğŸ”µ ë°© ì°¸ì—¬ ì¸ì› ëª©ë¡ ë³´ê¸° : GET /rooms/{id}/members
    @GetMapping("/{id}/members")
    public List<StudyRoomMember> listMembers(@PathVariable Long id) {
        return memberRepository.findAll().stream()
                .filter(m -> m.getRoom().getId().equals(id))
                .toList();
    }

    // ğŸ”´ ë°© ë‚˜ê°€ê¸° : DELETE /rooms/{id}/leave?username=ì•„ì´ë””
    @DeleteMapping("/{id}/leave")
    public String leaveRoom(@PathVariable Long id,
                            @RequestParam String username) {

        // ë°© ì¡´ì¬ í™•ì¸
        roomRepository.findById(id)
                .orElseThrow(() -> new RuntimeException("room not found: " + id));

        // ì´ ë°©ì— ì°¸ì—¬ ì¤‘ì¸ ë©¤ë²„ ëª©ë¡ í•„í„°ë§
        List<StudyRoomMember> targetMembers = memberRepository.findAll().stream()
                .filter(m ->
                        m.getRoom().getId().equals(id) &&
                        m.getUsername().equals(username)
                )
                .toList();

        if (targetMembers.isEmpty()) {
            return "í•´ë‹¹ ë°©ì— ì°¸ì—¬ ì¤‘ì´ ì•„ë‹™ë‹ˆë‹¤.";
        }

        memberRepository.deleteAll(targetMembers);

        return "ë°© ë‚˜ê°€ê¸° ì™„ë£Œ";
    }

    // ğŸ”´ ë°© ì‚­ì œí•˜ê¸° : DELETE /rooms/{id}?host=ë°©ì¥ì•„ì´ë””
    @DeleteMapping("/{id}")
    public String deleteRoom(@PathVariable Long id,
                             @RequestParam String host) {

        StudyRoom room = roomRepository.findById(id)
                .orElseThrow(() -> new RuntimeException("room not found: " + id));

        // ë°©ì¥ ê²€ì¦
        if (!room.getHost().equals(host)) {
            throw new RuntimeException("ë°©ì¥ë§Œ ë°©ì„ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
        }


        // ì´ ë°© ë©¤ë²„ ì „ë¶€ ì‚­ì œ
        List<StudyRoomMember> members = memberRepository.findAll().stream()
                .filter(m -> m.getRoom().getId().equals(id))
                .toList();

        memberRepository.deleteAll(members);

        // ë°© ì‚­ì œ
        roomRepository.delete(room);

        return "ë°© ì‚­ì œ ì™„ë£Œ";
    }
}
