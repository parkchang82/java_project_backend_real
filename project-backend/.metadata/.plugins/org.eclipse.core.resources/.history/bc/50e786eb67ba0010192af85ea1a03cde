package com.example.demo;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.authentication.dao.DaoAuthenticationProvider;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.web.SecurityFilterChain;

@Configuration
@EnableWebSecurity
public class WebSecurityConfig {
    
    // 1. CustomUserDetailsService Bean 등록 (@Service가 CustomUserDetailsService에 있어야 함)
	@Bean
	public UserDetailsService userDetailsService() {
		// CustomUserDetailsService가 @Service로 등록되어 있으면,
        // Spring이 알아서 Bean으로 주입해주기 때문에 new()로 직접 생성해도 문제가 없습니다.
        return new CustomUserDetailsService();
	}
	
    // 2. PasswordEncoder Bean 등록
	@Bean
	public BCryptPasswordEncoder passwordEncoder() {
		return new BCryptPasswordEncoder();
	}
	
    // 3. AuthenticationProvider Bean 등록 (인증 담당)
    // ❗❗❗ 무한 재귀 호출 문제를 수정했습니다. ❗❗❗
	@Bean
	public DaoAuthenticationProvider authenticationProvider() {
        DaoAuthenticationProvider authProvider = new DaoAuthenticationProvider();
        
        // 위에서 정의한 UserDetailsService와 PasswordEncoder를 설정합니다.
        authProvider.setUserDetailsService(userDetailsService());
        
        
        return authProvider; // 생성한 authProvider 객체를 반환합니다.
	}

    // 4. Security Filter Chain 설정
    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        http
            // CSRF 비활성화 (POST 요청 허용)
            .csrf(csrf -> csrf.disable()) 
            
            // 권한 설정
            .authorizeHttpRequests((requests) -> requests
                .requestMatchers("/css/**", "/js/**", "/images/**", "/webjars/**", "/custom-style.css").permitAll()
                // '/list_users'는 인증된 사용자만 접근 허용
                .requestMatchers("/list_users").authenticated() 
                
                // 그 외 모든 경로는 허용
                .anyRequest().permitAll()
            )
            
            // 폼 로그인 설정
            .formLogin(form -> form
            	.loginPage("/login")
                .usernameParameter("email")       // 로그인 폼의 사용자 이름 필드를 'email'로 설정
                .defaultSuccessUrl("/list_users") // 로그인 성공 후 이동할 URL
                .permitAll()
            )
            
            // 로그아웃 설정
            .logout(logout -> logout
                .logoutSuccessUrl("/") // 로그아웃 성공 후 이동할 URL
                .permitAll()
            );

        // ❗❗❗ 누락된 세미콜론과 괄호를 추가했습니다. ❗❗❗
        return http.build(); 
    }
}