package com.example.study;

import com.example.study.domain.Post;
import com.example.study.repository.PostRepository;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/posts")
public class PostController {

    private final PostRepository postRepository;

    public PostController(PostRepository postRepository) {
        this.postRepository = postRepository;
    }

    // âœ… ìš”ì²­ DTO
    public static record PostCreateReq(String title, String content, String author) {}
    public static record PostUpdateReq(String title, String content, String author) {}

    // ğŸŸ¢ CREATE (ê¸€ ì‘ì„±)
    @PostMapping
    public Post create(@RequestBody PostCreateReq req) {
        Post p = new Post();
        p.setTitle(req.title());
        p.setContent(req.content());
        p.setAuthor(req.author());
        return postRepository.save(p);
    }

    // ğŸŸ¢ READ (ì „ì²´ ëª©ë¡)
    @GetMapping
    public List<Post> list() {
        return postRepository.findAll();
    }

    // ğŸŸ¢ READ (ë‹¨ì¼ ì¡°íšŒ)
    @GetMapping("/{id}")
    public Post getOne(@PathVariable("id") Long id) {   // âœ… ìˆ˜ì •ë¨
        return postRepository.findById(id)
                .orElseThrow(() -> new RuntimeException("post not found: " + id));
    }

    // ğŸŸ¡ UPDATE (ìˆ˜ì •)
    @PutMapping("/{id}")
    public Post update(@PathVariable("id") Long id,     // âœ… ìˆ˜ì •ë¨
                       @RequestBody PostUpdateReq req) {

        Post p = postRepository.findById(id)
                .orElseThrow(() -> new RuntimeException("post not found: " + id));

        if (!p.getAuthor().equals(req.author())) {
            throw new RuntimeException("ì‘ì„±ìë§Œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
        }

        p.setTitle(req.title());
        p.setContent(req.content());

        return postRepository.save(p);
    }

    // ğŸ”´ DELETE (ì‚­ì œ)
    @DeleteMapping("/{id}")
    public String delete(@PathVariable("id") Long id,    // âœ… ìˆ˜ì •ë¨
                         @RequestParam("author") String author) {

        Post p = postRepository.findById(id)
                .orElseThrow(() -> new RuntimeException("post not found: " + id));

        if (!p.getAuthor().equals(author)) {
            throw new RuntimeException("ì‘ì„±ìë§Œ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
        }

        postRepository.delete(p);
        return "ì‚­ì œ ì™„ë£Œ: " + id;
    }
}
