package com.example.demo;

import java.util.Map;

// ... (ë‹¤ë¥¸ import ìƒëµ)
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder; // ì•”í˜¸í™”ë¥¼ ìœ„í•´ í•„ìš”
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;


@RestController
@RequestMapping("/api") // ëª¨ë“  APIëŠ” /apië¡œ ì‹œì‘
public class AuthController {
	
	@Autowired
	private UserRepository repo; // User ì—”í‹°í‹° ì €ì¥ì„ ìœ„í•´ í•„ìš”
	
	// (ë¡œê·¸ì¸ DTO ë° ë¡œì§ ìƒëµ...)
	// ... @PostMapping("/login") ë©”ì„œë“œ ...
	public static class LoginRequest {
	    private String username; // í”„ë¡ íŠ¸ì˜ email ê°’ì´ ë°”ì¸ë”©ë¨
	    private String password;
	    
	    // Getter, Setter ìƒëµ... (IDEì—ì„œ ìë™ ìƒì„±í•˜ê±°ë‚˜ ì§ì ‘ ì¶”ê°€í•´ì•¼ í•©ë‹ˆë‹¤)
	    public String getUsername() {
	        return username;
	    }
	    public String getPassword() {
	        return password;
	    }
	    // ...
	}
	
	
	@PostMapping("/login")
	public ResponseEntity<?> login(@RequestBody LoginRequest request) {
	    String email = request.getUsername(); // í”„ë¡ íŠ¸ì—ì„œ ë³´ë‚¸ username(ì‹¤ì œë¡œëŠ” email)
	    String rawPassword = request.getPassword(); // ì‚¬ìš©ìê°€ ì…ë ¥í•œ í‰ë¬¸ ë¹„ë°€ë²ˆí˜¸
	    
	    // 1. í•´ë‹¹ ì´ë©”ì¼ë¡œ DBì—ì„œ ì‚¬ìš©ì ì •ë³´ë¥¼ ì¡°íšŒ
	    User user = repo.findByEmail(email); // ğŸš¨ findByEmail ë©”ì„œë“œê°€ UserRepositoryì— ì •ì˜ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤!

	    if (user == null) {
	        // ì‚¬ìš©ìê°€ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²½ìš°
	        return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(Map.of("success", false, "message", "ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜ì…ë‹ˆë‹¤."));
	    }

	    // 2. ë¹„ë°€ë²ˆí˜¸ ë¹„êµ (ì•”í˜¸í™”ëœ ë¹„ë°€ë²ˆí˜¸ vs. ì‚¬ìš©ìê°€ ì…ë ¥í•œ í‰ë¬¸ ë¹„ë°€ë²ˆí˜¸)
	    BCryptPasswordEncoder encoder = new BCryptPasswordEncoder();
	    boolean passwordMatches = encoder.matches(rawPassword, user.getPassword());

	    if (passwordMatches) {
	        // ì¸ì¦ ì„±ê³µ ì‹œ
	        // ğŸš¨ ì‹¤ì œ í”„ë¡œì íŠ¸ì—ì„œëŠ” JWT í† í° ë“±ì„ ìƒì„±í•˜ì—¬ ì‘ë‹µí•´ì•¼ í•©ë‹ˆë‹¤.
	        return ResponseEntity.ok(Map.of("success", true, "message", "ë¡œê·¸ì¸ ì„±ê³µ"));
	    } else {
	        // ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠëŠ” ê²½ìš°
	        return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(Map.of("success", false, "message", "ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜ì…ë‹ˆë‹¤."));
	    }
	}
	
    // ğŸš€ íšŒì›ê°€ì… REST API
	@PostMapping("/signup")
	public ResponseEntity<?> registerUser(@RequestBody User user) {
		
        // 1. ë¹„ë°€ë²ˆí˜¸ ì•”í˜¸í™”
		BCryptPasswordEncoder encoder = new BCryptPasswordEncoder();
		String encodedPassword = encoder.encode(user.getPassword());
		user.setPassword(encodedPassword);
		
		try {
            // 2. DB ì €ì¥ ë° ì‘ë‹µ
			repo.save(user);
			return ResponseEntity.status(HttpStatus.CREATED).body(Map.of("success", true, "message", "íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."));
		} catch (Exception e) {
            // 3. ì˜¤ë¥˜ ì²˜ë¦¬ (ì˜ˆ: ì´ë©”ì¼ ì¤‘ë³µ)
			return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(Map.of("success", false, "message", "ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì´ë©”ì¼ì´ê±°ë‚˜ ì„œë²„ ì˜¤ë¥˜ì…ë‹ˆë‹¤."));
		}
	}
	
	@PostMapping("/changepassword") 
	public ResponseEntity<?> registerUser(@RequestBody User user) {
		
        // 1. ë¹„ë°€ë²ˆí˜¸ ì•”í˜¸í™”
		BCryptPasswordEncoder encoder = new BCryptPasswordEncoder();
		String encodedPassword = encoder.encode(user.getPassword());
		user.setPassword(encodedPassword);
		
		try {
            // 2. DB ì €ì¥ ë° ì‘ë‹µ
			repo.save(user);
			return ResponseEntity.status(HttpStatus.CREATED).body(Map.of("success", true, "message", "íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."));
		} catch (Exception e) {
            // 3. ì˜¤ë¥˜ ì²˜ë¦¬ (ì˜ˆ: ì´ë©”ì¼ ì¤‘ë³µ)
			return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(Map.of("success", false, "message", "ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì´ë©”ì¼ì´ê±°ë‚˜ ì„œë²„ ì˜¤ë¥˜ì…ë‹ˆë‹¤."));
		}
	}
}