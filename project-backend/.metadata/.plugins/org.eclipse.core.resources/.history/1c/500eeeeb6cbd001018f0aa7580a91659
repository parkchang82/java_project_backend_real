package com.example.demo;

import java.util.Map;

// ... (ë‹¤ë¥¸ import ìƒëµ)
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder; // ì•”í˜¸í™”ë¥¼ ìœ„í•´ í•„ìš”
import org.springframework.security.core.Authentication;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;
import com.example.demo.ChangePasswordRequest;
import jakarta.transaction.Transactional;


@RestController
@RequestMapping("/api") // ëª¨ë“  APIëŠ” /apië¡œ ì‹œì‘
public class AuthController {
	
	@Autowired
	private UserRepository repo; // User ì—”í‹°í‹° ì €ì¥ì„ ìœ„í•´ í•„ìš”
	
	// (ë¡œê·¸ì¸ DTO ë° ë¡œì§ ìƒëµ...)
	// ... @PostMapping("/login") ë©”ì„œë“œ ...
	public static class LoginRequest {
	    private String username; // í”„ë¡ íŠ¸ì˜ email ê°’ì´ ë°”ì¸ë”©ë¨
	    private String password;
	    
	    // Getter, Setter ìƒëµ... (IDEì—ì„œ ìë™ ìƒì„±í•˜ê±°ë‚˜ ì§ì ‘ ì¶”ê°€í•´ì•¼ í•©ë‹ˆë‹¤)
	    public String getUsername() {
	        return username;
	    }
	    public String getPassword() {
	        return password;
	    }
	    // ...
	 // AuthController.java íŒŒì¼ ë‚´ë¶€

	 // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ìš”ì²­ì„ ìœ„í•œ DTO
	}
	
	
	@PostMapping("/login")
	public ResponseEntity<?> login(@RequestBody LoginRequest request) {
	    String email = request.getUsername(); // í”„ë¡ íŠ¸ì—ì„œ ë³´ë‚¸ username(ì‹¤ì œë¡œëŠ” email)
	    String rawPassword = request.getPassword(); // ì‚¬ìš©ìê°€ ì…ë ¥í•œ í‰ë¬¸ ë¹„ë°€ë²ˆí˜¸
	    
	    // 1. í•´ë‹¹ ì´ë©”ì¼ë¡œ DBì—ì„œ ì‚¬ìš©ì ì •ë³´ë¥¼ ì¡°íšŒ
	    User user = repo.findByEmail(email); // ğŸš¨ findByEmail ë©”ì„œë“œê°€ UserRepositoryì— ì •ì˜ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤!

	    if (user == null) {
	        // ì‚¬ìš©ìê°€ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²½ìš°
	        return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(Map.of("success", false, "message", "ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜ì…ë‹ˆë‹¤."));
	    }

	    // 2. ë¹„ë°€ë²ˆí˜¸ ë¹„êµ (ì•”í˜¸í™”ëœ ë¹„ë°€ë²ˆí˜¸ vs. ì‚¬ìš©ìê°€ ì…ë ¥í•œ í‰ë¬¸ ë¹„ë°€ë²ˆí˜¸)
	    BCryptPasswordEncoder encoder = new BCryptPasswordEncoder();
	    boolean passwordMatches = encoder.matches(rawPassword, user.getPassword());

	    if (passwordMatches) {
	        // ì¸ì¦ ì„±ê³µ ì‹œ
	        // ğŸš¨ ì‹¤ì œ í”„ë¡œì íŠ¸ì—ì„œëŠ” JWT í† í° ë“±ì„ ìƒì„±í•˜ì—¬ ì‘ë‹µí•´ì•¼ í•©ë‹ˆë‹¤.
	        return ResponseEntity.ok(Map.of("success", true, "message", "ë¡œê·¸ì¸ ì„±ê³µ"));
	    } else {
	        // ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠëŠ” ê²½ìš°
	        return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(Map.of("success", false, "message", "ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜ì…ë‹ˆë‹¤."));
	    }
	}
	
    // ğŸš€ íšŒì›ê°€ì… REST API
	@PostMapping("/signup")
	public ResponseEntity<?> registerUser(@RequestBody User user) {
		
        // 1. ë¹„ë°€ë²ˆí˜¸ ì•”í˜¸í™”
		BCryptPasswordEncoder encoder = new BCryptPasswordEncoder();
		String encodedPassword = encoder.encode(user.getPassword());
		user.setPassword(encodedPassword);
		
		try {
            // 2. DB ì €ì¥ ë° ì‘ë‹µ
			repo.save(user);
			return ResponseEntity.status(HttpStatus.CREATED).body(Map.of("success", true, "message", "íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."));
		} catch (Exception e) {
            // 3. ì˜¤ë¥˜ ì²˜ë¦¬ (ì˜ˆ: ì´ë©”ì¼ ì¤‘ë³µ)
			return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(Map.of("success", false, "message", "ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì´ë©”ì¼ì´ê±°ë‚˜ ì„œë²„ ì˜¤ë¥˜ì…ë‹ˆë‹¤."));
		}
	}
	
	// AuthController.java íŒŒì¼ ë‚´ë¶€ì— ì¶”ê°€
	@Transactional
	@PostMapping("/changepassword")
	public ResponseEntity<?> changePassword(
	    @RequestBody ChangePasswordRequest request,
	    Authentication authentication // ğŸš¨ 1. ì¸ì¦ëœ ì‚¬ìš©ì ì •ë³´ë¥¼ ì£¼ì…ë°›ìŠµë‹ˆë‹¤.
	) {
	    // 2. Spring Security Contextì—ì„œ í˜„ì¬ ë¡œê·¸ì¸ëœ ì‚¬ìš©ìì˜ ID(Principal)ë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤.
	    String authenticatedEmail = authentication.getName(); 

	    // 3. ì¸ì¦ëœ ì´ë©”ì¼ë¡œ DBì—ì„œ ì‚¬ìš©ì ì •ë³´ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤.
	    User user = repo.findByEmail(authenticatedEmail); 

	    if (user == null) {
	        // ì´ë¡ ì ìœ¼ë¡œ ë°œìƒí•˜ê¸° ì–´ë ¤ìš´ ìƒí™©
	        return ResponseEntity.status(HttpStatus.NOT_FOUND).body(Map.of("success", false, "message", "ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
	    }
	    
	    // 4. í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ ê²€ì¦ ë¡œì§ (ê¸°ì¡´ê³¼ ë™ì¼)
	    BCryptPasswordEncoder encoder = new BCryptPasswordEncoder();
	    if (!encoder.matches(request.getCurrentPassword(), user.getPassword())) {
	        // ì´ ê²€ì¦ì—ì„œ ì‹¤íŒ¨í•˜ë©´ 'í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ ë¶ˆì¼ì¹˜' ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
	        return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(Map.of("success", false, "message", "ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”."));
	    }
	    
	    // 5. ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì•”í˜¸í™” ë° ì—…ë°ì´íŠ¸
	    String newEncodedPassword = encoder.encode(request.getNewPassword());
	    user.setPassword(newEncodedPassword);
	    
	    // íŠ¸ëœì­ì…˜ì´ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ìë™ìœ¼ë¡œ DBì— ë°˜ì˜ë©ë‹ˆë‹¤.
	    
	    return ResponseEntity.status(HttpStatus.OK).body(Map.of("success", true, "message", "ë¹„ë°€ë²ˆí˜¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤."));
	}
}