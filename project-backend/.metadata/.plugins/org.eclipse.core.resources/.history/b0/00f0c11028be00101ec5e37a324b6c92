package com.example.demo;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configurers.AbstractHttpConfigurer;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.web.cors.CorsConfiguration;
import org.springframework.web.cors.CorsConfigurationSource;
import org.springframework.web.cors.UrlBasedCorsConfigurationSource;

import java.util.Arrays;
import java.util.List;

@Configuration
@EnableWebSecurity
public class SecurityConfig {

    // 1. PasswordEncoder (ë¹„ë°€ë²ˆí˜¸ ì•”í˜¸í™”) ì„¤ì •
    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder(); // ê°€ì¥ ë„ë¦¬ ì‚¬ìš©ë˜ëŠ” ì•”í˜¸í™” ë°©ì‹
    }

    // 2. CORS ì„¤ì • (í”„ë¡ íŠ¸ì—”ë“œ í†µì‹  í—ˆìš©)
    @Bean
    public CorsConfigurationSource corsConfigurationSource() {
        CorsConfiguration configuration = new CorsConfiguration();
        
        // ğŸ’¡ í”„ë¡ íŠ¸ì—”ë“œê°€ ì‹¤í–‰ë˜ëŠ” ì£¼ì†Œ í—ˆìš© (í¬íŠ¸ 3000)
        configuration.setAllowedOrigins(List.of("http://localhost:3000", "http://127.0.0.1:3000")); 
        
        // í—ˆìš©í•  HTTP ë©”ì„œë“œ
        configuration.setAllowedMethods(Arrays.asList("GET", "POST", "PUT", "DELETE", "OPTIONS"));
        
        // í—ˆìš©í•  í—¤ë” (ëª¨ë“  í—¤ë” í—ˆìš©)
        configuration.setAllowedHeaders(List.of("*"));
        
        // ğŸ’¡ ì¸ì¦ ì •ë³´ (ì¿ í‚¤, JWT ë“±) êµí™˜ í—ˆìš©.
        configuration.setAllowCredentials(true); 

        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        // ëª¨ë“  URL ê²½ë¡œì— CORS ì„¤ì • ì ìš©
        source.registerCorsConfiguration("/**", configuration); 
        return source;
    }

    // 3. Security Filter Chain (ì¸ì¦/ì¸ê°€ ê·œì¹™) ì„¤ì •
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        
        http
            // ê¸°ë³¸ HTTP ì¸ì¦ ë¹„í™œì„±í™”
            .httpBasic(AbstractHttpConfigurer::disable)
            
            // ğŸ’¡ CSRF ë³´í˜¸ ë¹„í™œì„±í™” (STATELESS API)
            .csrf(AbstractHttpConfigurer::disable)
            
            // ğŸ’¡ ìœ„ì—ì„œ ì •ì˜í•œ CORS ì„¤ì • ì ìš©
            .cors(cors -> cors.configurationSource(corsConfigurationSource()))
            
            // ğŸ’¡ ì„¸ì…˜ì„ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ (STATELESS)
            .sessionManagement(session -> session
                .sessionCreationPolicy(SessionCreationPolicy.STATELESS))
            
            // â–â–â– ğŸš¨ 403 ì—ëŸ¬ ìˆ˜ì • ì§€ì  ğŸš¨ â–â–â–
            // ì ‘ê·¼ ê¶Œí•œ ì„¤ì • (ìš”ì²­ ê²½ë¡œë³„ ì„¤ì •)
            .authorizeHttpRequests(authz -> authz
                // '/api/login', '/api/signup' ê²½ë¡œëŠ” ëˆ„êµ¬ë‚˜ ì ‘ê·¼ ê°€ëŠ¥ (ì¸ì¦ ë¶ˆí•„ìš”)
                .requestMatchers("/api/login", "/api/signup").permitAll()
                
                // ğŸ’¡ '/api/profile', '/api/changepassword' ê²½ë¡œëŠ” ì¸ì¦ëœ ì‚¬ìš©ìë§Œ ì ‘ê·¼ ê°€ëŠ¥
                .requestMatchers("/api/profile", "/api/changepassword").authenticated()
                
                // ê·¸ ì™¸ ëª¨ë“  ìš”ì²­ë„ ì¸ì¦ë˜ì–´ì•¼ ì ‘ê·¼ ê°€ëŠ¥
                .anyRequest().authenticated() 
            );
            // â–â–â– ğŸš¨ ìˆ˜ì • ì™„ë£Œ â–â–â–
            
        // (JWT í† í° ì¸ì¦ì„ êµ¬í˜„í–ˆë‹¤ë©´, ì—¬ê¸°ì— .addFilter... ë¡œ í•„í„°ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤)

        return http.build();
    }
}